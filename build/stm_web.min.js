function SpeakToMe(e){function t(){if("ready"!=f)return void console.warn("Listen() called when not ready");var e={audio:!0};navigator.mediaDevices.getUserMedia(e).then(n).catch(function(e){console.error(e)})}function n(e){function t(e){v=e,r()}if(p=e,i({state:"listening"}),s=new AudioContext,c=s.createMediaStreamSource(e),u=s.createAnalyser(),l=s.createMediaStreamDestination(),c.channelCount=1,u.channelCount=1,l.channelCount=1,c.connect(u),u.connect(l),a.vad){m=SpeakToMeVAD({listener:t}),v="";scriptprocessor=s.createScriptProcessor(2048,1,1),scriptprocessor.onaudioprocess=m.onAudioProcessingEvent,c.connect(scriptprocessor)}var n={audioBitsPerSecond:RECORDING_BITS_PER_SECOND,mimeType:RECORDING_MIME_TYPE};d=new MediaRecorder(l.stream,n),d.start(),a.vad||setTimeout(r,a.timeout),d.onstop=function(t){if(i({state:"processing"}),a.vad&&"novoice"==v||!f[0].size)i({state:"result",data:[]}),i({state:"ready"});else{o(new Blob(f,{type:"audio/ogg; codecs=opus"}))}f=[],d=null,s=null,c=null,u=null,l=null,e=null,scriptprocessor=null};var f=[];d.ondataavailable=function(e){f.push(e.data)}}function o(e){i({state:"sending"}),fetch(a.serverURL,{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){"ok"===e.status?(i({state:"result",data:e.data}),i({state:"ready"})):console.error("Error parsing JSON response:",error)}).catch(function(e){console.error("Fetch error:",e)})}function r(){if("listening"!=f)return void console.warn("stopListening(): stopping but not listening?!");p.getAudioTracks()[0].stop(),d.stop(),c.disconnect(scriptprocessor),c.disconnect(u),u.disconnect(l)}function i(e){if(f=e.state,!a.listener)return void console.warn("SpeakToMe: You need to initialize SpeakToMe with an event listener!");try{a.listener(e)}catch(e){console.error("SpeakToMe: Listener error",e)}}var a={vad:!0,timeout:RECORDING_TIMEOUT,continuous:!1,serverURL:STT_SERVER_URL,listener:null};e&&(!1===e.vad&&(a.vad=!1),e.timeout&&(a.timeout=e.timeout),e.listener&&(a.listener=e.listener));var s,c,u,l,d,p,v,f="ready",m=null;return{listen:t,stop:r,setListener:function(e){a.listener=e}}}function SpeakToMeVAD(e){function t(){u=new Int16Array(c),l=0,d=0,samplessilence=0,p=!1,v=!1,f=Date.now(),m=Date.now(),M=!1}function n(e){var t=e.length*e.BYTES_PER_ELEMENT,n=Module._malloc(t),o=new Uint8Array(Module.HEAPU8.buffer,n,t);o.set(new Uint8Array(e.buffer));var r=s(o.byteOffset,e.length,48e3,e[0],e[100],e[2e3]);return Module._free(o.byteOffset),r}function o(e,t){for(var n=0;n<t.length;n++){var o=Math.max(-1,Math.min(1,t[n]));e[n]=o<0?32768*o:32767*o}}function r(e){var t=new Int16Array(e.inputBuffer.getChannelData(0).length);o(t,e.inputBuffer.getChannelData(0));for(var r=0;r<Math.ceil(t.length/c)&&!M;r++){var a=r*c,s=a+c;if(a+c>t.length)u.set(t.slice(a)),l=t.length-a;else{l>0?(s-=this.leftovers,u.set(t.slice(a,s),l),l=0):u.set(t.slice(a,s));var S=n(u);u=new Int16Array(c);var E=Date.now();0===S?p&&(samplessilence+=E-m,samplessilence>h&&(v=!0)):(d+=E-m)>g&&(p=!0),m=E,p&&v?(M=!0,i("finishedvoice")):(E-f)/1e3>w&&(M=!0,i(p?"timeout":"novoice"))}}}function i(e){try{a.listener(e)}catch(e){console.log("SpeakToMe_VAD: onCompleteCallback exception",e)}t()}var a={listener:function(){console.error("SpeakToMeVAD: No listener configured!")}};e&&void 0!=e.listener&&(a.listener=e.listener),Module.cwrap("main")(),Module.cwrap("setmode","number",["number"])(3);var s=Module.cwrap("process_data","number",["number","number","number","number","number","number"]),c=480,u=new Int16Array(c),l=0,d=0,p=!1,v=!1,f=Date.now(),m=Date.now(),M=!1,g=250,h=1500,w=6;return t(),{reset:t,onAudioProcessingEvent:r}}var STT_SERVER_URL="https://speaktome.services.mozilla.com",RECORDING_TIMEOUT=3e3,RECORDING_BITS_PER_SECOND=16e3,RECORDING_MIME_TYPE="audio/ogg";!function(){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise(function(n,o){t.call(navigator,e,n,o)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}(),"undefined"!=typeof module&&(module.exports=SpeakToMe),"undefined"!=typeof module&&(module.exports=SpeakToMe);var Module={preRun:[],postRun:[],print:function(){return function(e){console.log("[webrtc_vad.js print]",e)}}(),printErr:function(e){console.error("[webrtc_vad.js error]",e)},canvas:void 0,setStatus:function(e){console.log("[webrtc_vad.js status] ",e)},totalDependencies:0,monitorRunDependencies:function(e){this.totalDependencies=Math.max(this.totalDependencies,e),Module.setStatus(e?"Preparing... ("+(this.totalDependencies-e)+"/"+this.totalDependencies+")":"All downloads complete.")}};Module.setStatus("Loading webrtc_vad..."),window.onerror=function(e){Module.setStatus("Exception thrown, see JavaScript console"),Module.setStatus=function(e){e&&Module.printErr("[post-exception status] "+e)}},Module.noInitialRun=!0,Module.onRuntimeInitialized=function(){Module.setStatus("Webrtc_vad and SpeakToMeVad loaded")};
